function onLoadInit(){tinyMCEPopup.resizeToInnerSize(),tinymce.isGecko&&(document.body.spellcheck=tinyMCEPopup.editor.getParam("gecko_spellcheck")),document.getElementById("htmlSource").value=tinyMCEPopup.editor.getContent({source_view:!0}),beautify("htmlSource"),the.coloring_active&&activateCodeColoring("htmlSource"),the.wraptext_active?(activateWrapText(),document.getElementById("wraptext").checked=!0):document.getElementById("wraptext").checked=!1,resizeInputs("htmlSource"),window.onresize=function(){resizeInputs("htmlSource")}}function activateCodeColoring(e){the.coloring_active=!0,document.getElementById("search_replace").className="",document.getElementById("reintendt").className="",document.getElementById("autocompletion").disabled=!1,pluginCodeMirror=CodeMirror.fromTextArea(document.getElementById(e),pluginOptions),hlLine=pluginCodeMirror.setLineClass(0,"activeline"),pluginCodeMirror.focus()}function deactivateCodeColoring(){the.coloring_active=!1,document.getElementById("undo").className="disabled",document.getElementById("redo").className="disabled",document.getElementById("search_replace").className="disabled",document.getElementById("reintendt").className="disabled",document.getElementById("autocompletion").disabled=!0,pluginCodeMirror.toTextArea(),pluginCodeMirror=null,resizeInputs("htmlSource")}function activateWrapText(){the.wraptext_active=!0;var e=document.getElementById("htmlSource").nextSibling;-1==e.className.indexOf("wrapText")&&(e.className+=" wrapText")}function deactivateWrapText(){the.wraptext_active=!1;var e=document.getElementById("htmlSource").nextSibling,t=e.className.split(" "),r=t.indexOf("wrapText");r&&(t.splice(r,1),e.className=t.join(" "))}function toggleHighlighting(e,t){e.checked?activateCodeColoring(t):deactivateCodeColoring()}function toggleAutocompletion(e){the.autocompletion_active=e.checked?!0:!1}function toggleWrapText(e){e.checked?activateWrapText():deactivateWrapText()}function saveContent(){tinyMCEPopup.editor.setContent(pluginCodeMirror.getValue(),{source_view:!0}),tinyMCEPopup.close()}function resizeInputs(e){var t,r=tinyMCEPopup.dom.getViewPort(window);t=document.getElementById(e),t&&(t.style.height=r.h-65+"px")}function toggleSearch(e,t){if(!the.coloring_active)return!1;e.className="";var r=document.getElementById(t);"none"==r.style.display?(e.className="selected",r.style.display="block"):r.style.display="none"}function undo(){pluginCodeMirror.undo()}function redo(){pluginCodeMirror.redo()}function onChangeCallback(e){var t=e.historySize().undo,r=e.historySize().redo;document.getElementById("undo").className=t>0?"":"disabled",document.getElementById("redo").className=r>0?"":"disabled"}function reIntendt(e){return the.coloring_active?(deactivateCodeColoring(),document.getElementById("searchWindow").style.display="none",beautify(e),void activateCodeColoring(e)):!1}function unmark(){for(var e=0;e<marked.length;++e)marked[e]();marked.length=0}function searchCode(){unmark();var e=document.getElementById("query").value;if(!e)return!1;if(!pluginCodeMirror.getSearchCursor(e).findNext())return alert(tinyMCEPopup.getLang("codemagic_dlg.nothing_found")),!1;for(var t=pluginCodeMirror.getSearchCursor(e);t.findNext();)marked.push(pluginCodeMirror.markText(t.from(),t.to(),"searched"));lastQuery!=e&&(lastPos=null);var t=pluginCodeMirror.getSearchCursor(e,lastPos||pluginCodeMirror.getCursor());(t.findNext()||(t=pluginCodeMirror.getSearchCursor(e),t.findNext()))&&(pluginCodeMirror.setSelection(t.from(),t.to()),lastQuery=e,lastPos=t.to())}function replaceCode(){unmark();var e=document.getElementById("query").value,t=document.getElementById("replace").value;if(!e)return!1;if(!pluginCodeMirror.getSearchCursor(e).findNext())return alert(tinyMCEPopup.getLang("codemagic_dlg.nothing_to_replace")),!1;for(var r=pluginCodeMirror.getSearchCursor(e);r.findNext();)pluginCodeMirror.replaceRange(t,r.from(),r.to())}function stopEvent(){this.preventDefault?(this.preventDefault(),this.stopPropagation()):(this.returnValue=!1,this.cancelBubble=!0)}function addStop(e){return e.stop||(e.stop=stopEvent),e}function connect(e,t,r){function o(e){r(addStop(e||window.event))}"function"==typeof e.addEventListener?e.addEventListener(t,o,!1):e.attachEvent("on"+t,o)}function forEach(e,t){for(var r=0,o=e.length;o>r;++r)t(e[r])}function startComplete(){function e(e){if(""!=e){if(e=e.replace(/^\s+|\s+$/g,""),n=unPairedTags.inArray(e)?!0:!1,null!=specialTags[e]&&o)var t=specialTags[e].tag,r=i.start+e.length+specialTags[e].cusror;else if(o&&n)var t=e+" />",r=i.start+e.length+3;else if(o)var t=e+"></"+e+">",r=i.start+e.length+1;else var t=e+">",r=i.start+e.length+1;pluginCodeMirror.replaceRange(t,{line:a.line,ch:i.start},{line:a.line,ch:i.end}),pluginCodeMirror.setCursor({line:a.line,ch:r})}}function t(){g||(g=!0,c.parentNode.removeChild(c))}function r(){e(s.options[s.selectedIndex].innerHTML),t(),setTimeout(function(){pluginCodeMirror.focus()},50)}var o,n;if(!pluginCodeMirror.somethingSelected()){var a=pluginCodeMirror.getCursor(!1),i=pluginCodeMirror.getTokenAt(a);if(0==i.string.indexOf("<")&&0!=i.string.indexOf("</"))i.string=i.string.replace("<",""),i.start++,o=!0;else{if(0!=i.string.indexOf("</"))return;i.string=i.string.replace("</",""),i.start+=2,o=!1}var l=getCompletions(i,o);if(l.length){var c=document.createElement("div");c.className="completions";var s=c.appendChild(document.createElement("select"));s.multiple=!1,1==l.length&&(s.multiple=!0);for(var d=0;d<l.length;++d){var u=s.appendChild(document.createElement("option"));u.appendChild(document.createTextNode(l[d]))}s.firstChild.selected=!0,s.size=Math.min(10,l.length);var p=pluginCodeMirror.cursorCoords();c.style.left=p.x+"px",p.yBot>448&&(p.yBot=p.yBot-165),c.style.top=p.yBot+"px",document.body.appendChild(c);var g=!1;return connect(s,"blur",t),connect(s,"keydown",function(e){var o=e.keyCode;13==o||32==o||9==o?(e.stop(),r()):27==o?(e.stop(),t(),pluginCodeMirror.focus()):38!=o&&40!=o&&16!=o&&17!=o&&18!=o&&91!=o&&92!=o&&(t(),pluginCodeMirror.focus(),39!=o&&37!=o?setTimeout(startComplete,50):e.stop())}),connect(s,"dblclick",r),s.focus(),window.opera&&setTimeout(function(){g||s.focus()},100),!0}}}function getCompletions(e,t){function r(e){0==e.indexOf(n)&&o.push(e)}var o=[],n=e.string;return t?forEach(tagNames,r):forEach(pairedTags,r),o}function beautify(e){if(!the.beautify_in_progress){the.beautify_in_progress=!0;var t=document.getElementById(e).value.replace(/^\s+/,""),r=4,o=" ",n="collapse";document.getElementById(e).value=style_html(t,r,o,120,n),the.beautify_in_progress=!1}}var the={beautify_in_progress:!1,coloring_active:!0,autocompletion_active:!0,wraptext_active:!1},hlLine=null,lastPos=null,lastQuery=null,marked=[],pluginCodeMirror=null,pluginOptions={lineNumbers:!0,mode:"text/html",indentUnit:4,matchBrackets:!0,onCursorActivity:function(){pluginCodeMirror.setLineClass(hlLine,null),hlLine=pluginCodeMirror.setLineClass(pluginCodeMirror.getCursor().line,"activeline")},onKeyEvent:function(e,t){if(the.autocompletion_active){if("<"==String.fromCharCode(null==t.which?t.keyCode:t.which)){t.stop();{var r=pluginCodeMirror.getCursor(!1);pluginCodeMirror.getTokenAt(r)}return pluginCodeMirror.replaceRange("<",r),setTimeout(startComplete,50),!0}if(32==t.keyCode&&(t.ctrlKey||t.metaKey)&&!t.altKey)return t.stop(),startComplete()}},onHighlightComplete:onChangeCallback};tinyMCEPopup.requireLangPack(),tinyMCEPopup.on("init",onLoadInit),CodeMirror.defineMode("htmlmixed",function(e){function t(e,t){var r=a.token(e,t.htmlState);return"xml-tag"==r&&">"==e.current()&&t.htmlState.context&&(/^script$/i.test(t.htmlState.context.tagName)?(t.token=o,t.localState=i.startState(a.indent(t.htmlState,""))):/^style$/i.test(t.htmlState.context.tagName)&&(t.token=n,t.localState=l.startState(a.indent(t.htmlState,"")))),r}function r(e,t,r){var o=e.current(),n=o.search(t);return n>-1&&e.backUp(o.length-n),r}function o(e,o){return e.match(/^<\/\s*script\s*>/i,!1)?(o.token=t,o.curState=null,t(e,o)):r(e,/<\/\s*script\s*>/,i.token(e,o.localState))}function n(e,o){return e.match(/^<\/\s*style\s*>/i,!1)?(o.token=t,o.localState=null,t(e,o)):r(e,/<\/\s*style\s*>/,l.token(e,o.localState))}var a=CodeMirror.getMode(e,{name:"xml",htmlMode:!0}),i=CodeMirror.getMode(e,"javascript"),l=CodeMirror.getMode(e,"css");return{startState:function(){var e=a.startState();return{token:t,localState:null,htmlState:e}},copyState:function(e){if(e.localState)var t=CodeMirror.copyState(e.token==n?l:i,e.localState);return{token:e.token,localState:t,htmlState:CodeMirror.copyState(a,e.htmlState)}},token:function(e,t){return t.token(e,t)},indent:function(e,r){return e.token==t||/^\s*<\//.test(r)?a.indent(e.htmlState,r):e.token==o?i.indent(e.localState,r):l.indent(e.localState,r)},electricChars:"/{}:"}}),CodeMirror.defineMIME("text/html","htmlmixed");var tagNames="a abbr acronym address applet area b base basefont bdo big blockquote body br button caption center cite code col colgroup dd del dfn dir div dl dt em fieldset font form frame  frameset h1 h2 h3 h4 h5 h6 head hr html i iframe img input ins isindex kbd label legend li link map menu meta noframes noscript object ol optgroup option p param pre q s samp script select small span strike strong style sub sup table tbody td textarea tfoot th thead title tr tt u ul var".split(" "),pairedTags="a abbr acronym address applet b bdo big blockquote body button caption center cite code colgroup del dfn dir div dl em fieldset font form frameset h1 h2 h3 h4 h5 h6 head html i iframe ins kbd label legend li map menu noframes noscript object ol optgroup option p pre q s samp script select small span strike strong style sub sup table tbody td textarea tfoot th thead title tr tt u ul var".split(" "),unPairedTags="area base basefont br col dd dt frame hr img input isindex link meta param".split(" "),specialTags={applet:{tag:'applet width="" height=""></applet>',cusror:8},area:{tag:'area alt="" />',cusror:6},base:{tag:'base href="" />',cusror:7},form:{tag:'form action=""></form>',cusror:9},img:{tag:'img src="" alt="" />',cusror:6},map:{tag:'map name=""></map>',cusror:7},meta:{tag:'meta content="" />',cusror:10},optgroup:{tag:'optgroup label=""></optgroup>',cusror:8},param:{tag:'param name="" />',cusror:7},script:{tag:'script type=""></script>',cusror:7},style:{tag:'style type=""></style>',cusror:7},textarea:{tag:'textarea cols="" rows=""></textarea>',cusror:7}};Array.prototype.inArray=function(e){for(var t in this)if(this[t]===e)return!0;return!1};
